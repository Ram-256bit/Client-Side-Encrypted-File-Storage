<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Storage</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; padding: 1rem; background: #eef2f5; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        button { background: #3498db; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:hover { background: #2980b9; }
        .file-item { background: #f8f9fa; border-left: 5px solid #2ecc71; padding: 15px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .btn-group button { width: auto; margin-left: 5px; font-size: 0.8rem; }
        .magic-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 20px; text-align: center; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Secure Multimedia Storage</h2>
    
    <div id="magicView" class="magic-box">
        <h3>ðŸ”’ Protected File Shared With You</h3>
        <p id="magicFileName">Loading...</p>
        <input type="password" id="magicPassword" placeholder="Enter Sender's Password">
        <button onclick="decryptMagicFile()">Decrypt & Download</button>
        <br><br>
        <a href="/">Go to Dashboard</a>
    </div>

    <div id="dashboardView">
        <h3>1. Encrypt & Upload</h3>
        <input type="file" id="fileInput">
        <input type="password" id="password" placeholder="Set Secret Password">
        <button onclick="uploadFile()">Encrypt & Upload</button>
        <p id="status"></p>

        <h3>2. Files Available to Download</h3>
        <div id="fileList">Loading...</div>
    </div>
</div>

<script>
    const SERVER_URL = "http://localhost:3000";
    let magicFileMeta = null;

    // --- INIT: CHECK FOR MAGIC LINK ---
    window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('id');

        if (fileId) {
            // MAGIC LINK MODE
            document.getElementById('dashboardView').style.display = 'none';
            document.getElementById('magicView').style.display = 'block';
            
            try {
                const res = await fetch(`${SERVER_URL}/api/file/${fileId}`);
                if (!res.ok) throw new Error("File not found");
                magicFileMeta = await res.json();
                document.getElementById('magicFileName').innerText = `File: ${magicFileMeta.originalName}`;
            } catch (e) {
                document.getElementById('magicFileName').innerText = "Error: Invalid Link or File Removed.";
            }
        } else {
            // NORMAL MODE
            loadFiles();
        }
    };

    // --- CRYPTO HELPER ---
    async function getCryptoKey(password, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey(
            "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveKey"]
        );
        return window.crypto.subtle.deriveKey(
            { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
            keyMaterial, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]
        );
    }

    // --- UPLOAD ---
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const password = document.getElementById('password').value;
        if (!fileInput.files[0] || !password) return alert("Missing details");

        const file = fileInput.files[0];
        const salt = window.crypto.getRandomValues(new Uint8Array(16));
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const key = await getCryptoKey(password, salt);
        const encryptedData = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, await file.arrayBuffer());

        const formData = new FormData();
        formData.append("file", new Blob([encryptedData]), file.name + ".enc");
        formData.append("iv", JSON.stringify(Array.from(iv)));
        formData.append("salt", JSON.stringify(Array.from(salt)));

        await fetch(`${SERVER_URL}/upload`, { method: "POST", body: formData });
        alert("Uploaded!");
        loadFiles();
    }

    // --- LOAD FILES ---
    async function loadFiles() {
        const res = await fetch(`${SERVER_URL}/files`);
        const files = await res.json();
        const listDiv = document.getElementById('fileList');
        listDiv.innerHTML = "";
        
        files.forEach(file => {
            const div = document.createElement('div');
            div.className = "file-item";
            div.innerHTML = `
                <span>${file.originalName}</span>
                <div class="btn-group">
                    <button onclick="copyLink('${file.id}')">Copy Link</button>
                    <button onclick="decryptFile('${file.id}')" style="background:#27ae60">Decrypt</button>
                </div>
            `;
            listDiv.appendChild(div);
        });
    }

    // --- ACTIONS ---
    function copyLink(id) {
        const link = `${SERVER_URL}/?id=${id}`;
        navigator.clipboard.writeText(link);
        alert("Magic Link Copied: " + link);
    }

    // Decrypt from Dashboard (Wraps the core logic)
    async function decryptFile(id) {
        const res = await fetch(`${SERVER_URL}/api/file/${id}`);
        const meta = await res.json();
        const pass = prompt(`Enter password for ${meta.originalName}`);
        if(pass) coreDecrypt(meta, pass);
    }

    // Decrypt from Magic Link Page
    function decryptMagicFile() {
        const pass = document.getElementById('magicPassword').value;
        if(pass && magicFileMeta) coreDecrypt(magicFileMeta, pass);
    }

    // Core Decrypt Logic
    async function coreDecrypt(meta, password) {
        try {
            const res = await fetch(`${SERVER_URL}/download/${meta.fileName}`);
            const encryptedBuffer = await res.arrayBuffer();
            const iv = new Uint8Array(JSON.parse(meta.iv));
            const salt = new Uint8Array(JSON.parse(meta.salt));
            const key = await getCryptoKey(password, salt);
            
            const decryptedData = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, encryptedBuffer);
            
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(new Blob([decryptedData]));
            link.download = meta.originalName.replace(".enc", "");
            link.click();
        } catch (e) {
            alert("Wrong Password!");
        }
    }
</script>

</body>
</html>